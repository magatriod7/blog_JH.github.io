---
title: 자바스크립트 자료구조 WeakMap WeakSet
date: 2022-08-14
description: WeakMap WeakSet
tags:
  - JS
---

### garbage collector

메모리의 관리 방법 중 하나로, 시스템에서 더 이상 사용하지 않을 메모리를 자동으로 비워주는 것을 말합니다.

C언어의 경우 메모리를 할당한 후 수동으로 해제까지 직접 해줘야하는 특징을 가지고 있습니다. 반면 JS는 가비지 컬렉션을 이용하는 언어이기 때문에 자동적으로 소스코드에서 사용하지 않을 메모리를 초기화 해줍니다.

### WeakMap, WeakSet

WeakMap은 사용자가 메모리에 접속할 수 있도록 설정은 해뒀지만 그 사실을 가비지 컬렉터는 몰라 자동적으로 초기화되는 특징을 가진 자료구조입니다.


map

```
let john = { name: "John" };
let map = new Map();
map.set(john, "...");
john = null; // overwrite the reference
//john은 null로 초기화 되었지만 여전히 저희는 map.keys()를 통해 접근 가능합니다.
```

Map의 경우, john이 초기화 되었지만 가비지 컬렉터는 여전히 john의 원래 메모리가
map 안의 key 값으로 이용되고 있다는 것을 알고 있습니다. 고로 데이터를 초기화하지 않아 여전히 map 안에 
john의 메모리를 key 값으로 가지는 entry가 존재합니다.

weakMap

```
let john = { name: "John" };
const weakMap = new WeakMap();
weakMap.set(john, '...');
john = null // john은 위크맵과 메모리에서 삭제됩니다. 메모리에 접근 불가능합니다.
```

반면 weakMap의 경우 john이 null로 초기화 된다면 가비지 컬렉터는 weakMap 내부에서
john의 원래 주소를 key 값으로 참조하고 있다는 것을 알지 못 합니다. 그저 더 이상 접근할 수 없는 데이터로 이해하게 되는거죠.
결국 weakMap 내부 john을 key 값으로 참조하던 entry가 사라지게 됩니다.

적절한 비유는 아니라고 생각하지만 어머님에게 사용하고 있으니 치우지 말라고 말해둔 상태라 치우지 않는 것은 Map,
사용은 하고 있지만 치우지 말라고 이야기를 하지 않아 어머니께서 치우시는 것이 weakMap이네요.

어떻게 사용할 수 있을지 좀 더 예시를 들어보겠습니다.

### weakMap 예시 1

여러분께서 블로그를 만드셨습니다! 블로그를 보다 좋은 방향으로 발전시키기 위해서 현재 방문 중인
사람들의 정보를 수집할 예정입니다. 그를 위한 소스코드도 완성했군요.

```
//visitsCount.js with map
let visitsCountMap = new Map(); // map: user => visits count

function countUser(user) {
  let count = visitsCountMap.get(user) || 0;
  visitsCountMap.set(user, count + 1);
}

let john = { name: "John" };

countUser(john); // count his visits

john = null;
```

여러분께서 만든 visitsCountMap에는 방문자의 정보가 기입되고 방문자 수가 하나씩 늘어날 것입니다. 얼마나 많은 사람이 올지를 기대하면서 기다리던 도중
첫 방문자로 john이 들어왔고 john이 나가면서 john의 정보를 지웠습니다.

눈치채셨겠지만 이렇게 짜게 된다면 블로그가 배포되면서 조회수가 늘어나기만 할 뿐 줄어들지를 않습니다.

john을 null로 처리하더라도 visitsCountMap는 Map 객체이기 때문에 가비지 컬렉터는 자동적으로 john의 메모리를 초기화시키지 않게 됩니다.
john의 원래 메모리를 참조하는 entry가 visitsCountMap 내부에 계속 쌓이게 될 것입니다.

이를 해결하기 위해서는 john을 null처리를 하기 전에 visitsCountMap.delete(john)을 추가하여
john을 key로 두는 entry를 제거해야합니다.

하지만 weakMap을 사용하면 이 부분이 완화됩니다.

```
let visitsCountMap = new WeakMap();

function countUser(user) {
  let count = visitsCountMap.get(user) || 0;
  visitsCountMap.set(user, count + 1);
}

let john = { name: "John" };

countUser(john); // count his visits

john = null;// john이 지워집니다.
```

weakMap 내부에 저장되어 있는 john을 key로 두는 entry는 john이 null로 초기화되면서 가비지 컬렉터에 의해서 john이 초기화되기 때문에 자동적으로 삭제될 것입니다.

이렇게 휘발적인 데이터를 다뤄야할 때 weakMap이 사용될 수 있습니다.

weakMap의 특징으로 내부 entry의 key 값이 객체여야합니다.

비슷한 특징을 가진 weakSet의 경우도 기본적으로 성질은 Set과 비슷하지만 내부 요소가 weakMap과 같이 
전부 객체여야하고 각 객체가 참조하던 메모리가 초기화 될 경우 해당 메모리를 다른 곳에서 참조하지 않는 상태면 자동적으로 
해당 객체가 요소에서 삭제될 것입니다.


---

[참고](https://velog.io/@y1andyu/JavaScript-Weak-Map-Weak-Set)

[참고](https://javascript.info/weakmap-weakset)